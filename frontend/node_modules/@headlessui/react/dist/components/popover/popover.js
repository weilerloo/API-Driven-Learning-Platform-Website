"use client";import{useFocusRing as He}from"@react-aria/focus";import{useHover as Ue}from"@react-aria/interactions";import v,{createContext as Fe,useCallback as te,useContext as Be,useEffect as pe,useMemo as _e,useRef as ie,useState as ue}from"react";import{useActivePress as Ne}from'../../hooks/use-active-press.js';import{useElementSize as we}from'../../hooks/use-element-size.js';import{useEvent as y}from'../../hooks/use-event.js';import{useEventListener as Ke}from'../../hooks/use-event-listener.js';import{useId as oe}from'../../hooks/use-id.js';import{useIsoMorphicEffect as We}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as Ae}from'../../hooks/use-latest-value.js';import{useOnDisappear as Ve}from'../../hooks/use-on-disappear.js';import{useOutsideClick as je}from'../../hooks/use-outside-click.js';import{useOwnerDocument as ce}from'../../hooks/use-owner.js';import{useResolveButtonType as $e}from'../../hooks/use-resolve-button-type.js';import{MainTreeProvider as Ce,useMainTreeNode as Je,useRootContainers as Xe}from'../../hooks/use-root-containers.js';import{useScrollLock as qe}from'../../hooks/use-scroll-lock.js';import{useSlot as re}from'../../hooks/use-slot.js';import{optionalRef as ze,useSyncRefs as z}from'../../hooks/use-sync-refs.js';import{Direction as k,useTabDirection as Oe}from'../../hooks/use-tab-direction.js';import{transitionDataAttributes as xe,useTransition as De}from'../../hooks/use-transition.js';import{CloseProvider as Le}from'../../internal/close-provider.js';import{FloatingProvider as Ye,useFloatingPanel as Qe,useFloatingPanelProps as Ze,useFloatingReference as et,useResolvedAnchor as tt}from'../../internal/floating.js';import{Hidden as ve,HiddenFeatures as Te}from'../../internal/hidden.js';import{OpenClosedProvider as ot,ResetOpenClosedProvider as rt,State as Y,useOpenClosed as he}from'../../internal/open-closed.js';import{useSlice as Q}from'../../react-glue.js';import{isDisabledReactIssue7711 as Se}from'../../utils/bugs.js';import*as Me from'../../utils/dom.js';import{Focus as I,FocusResult as Ee,FocusableMode as nt,focusIn as K,getFocusableElements as Ge,isFocusableElement as lt}from'../../utils/focus-management.js';import{match as ne}from'../../utils/match.js';import'../../utils/micro-task.js';import{getOwnerDocument as at}from'../../utils/owner.js';import{RenderFeatures as de,forwardRefWithAs as Z,mergeProps as be,useRender as le}from'../../utils/render.js';import{Keys as W}from'../keyboard.js';import{Portal as st,useNestedPortals as pt}from'../portal/portal.js';import{PopoverStates as c}from'./popover-machine.js';import{PopoverContext as it,usePopoverMachine as ut,usePopoverMachineContext as ye}from'./popover-machine-glue.js';let ge=Fe(null);ge.displayName="PopoverGroupContext";function ke(){return Be(ge)}let fe=Fe(null);fe.displayName="PopoverPanelContext";function ct(){return Be(fe)}let dt="div";function ft(E,L){var H;let F=oe(),{__demoMode:B=!1,...T}=E,n=ut({id:F,__demoMode:B}),g=ie(null),t=z(L,ze(o=>{g.current=o})),[_,d,r,O,b]=Q(n,te(o=>[o.popoverState,o.button,o.panel,o.buttonId,o.panelId],[])),f=ce((H=g.current)!=null?H:d),A=Ae(O),a=Ae(b),i=_e(()=>({buttonId:A,panelId:a,close:n.actions.close}),[A,a,n]),u=ke(),l=u==null?void 0:u.registerPopover,P=y(()=>{var o;return(o=u==null?void 0:u.isFocusWithinPopoverGroup())!=null?o:(f==null?void 0:f.activeElement)&&((d==null?void 0:d.contains(f.activeElement))||(r==null?void 0:r.contains(f.activeElement)))});pe(()=>l==null?void 0:l(i),[l,i]);let[m,V]=pt(),j=Je(d),$=Xe({mainTreeNode:j,portals:m,defaultContainers:[{get current(){return n.state.button}},{get current(){return n.state.panel}}]});Ke(f==null?void 0:f.defaultView,"focus",o=>{var h,q,G,U,S,N;o.target!==window&&Me.isHTMLorSVGElement(o.target)&&n.state.popoverState===c.Open&&(P()||n.state.button&&n.state.panel&&($.contains(o.target)||(q=(h=n.state.beforePanelSentinel.current)==null?void 0:h.contains)!=null&&q.call(h,o.target)||(U=(G=n.state.afterPanelSentinel.current)==null?void 0:G.contains)!=null&&U.call(G,o.target)||(N=(S=n.state.afterButtonSentinel.current)==null?void 0:S.contains)!=null&&N.call(S,o.target)||n.actions.close()))},!0);let x=_===c.Open;je(x,$.resolveContainers,(o,h)=>{n.actions.close(),lt(h,nt.Loose)||(o.preventDefault(),d==null||d.focus())});let J=re({open:_===c.Open,close:n.actions.refocusableClose}),ee=Q(n,te(o=>ne(o.popoverState,{[c.Open]:Y.Open,[c.Closed]:Y.Closed}),[])),X={ref:t},C=le();return v.createElement(Ce,{node:j},v.createElement(Ye,null,v.createElement(fe.Provider,{value:null},v.createElement(it.Provider,{value:n},v.createElement(Le,{value:n.actions.refocusableClose},v.createElement(ot,{value:ee},v.createElement(V,null,C({ourProps:X,theirProps:T,slot:J,defaultTag:dt,name:"Popover"}))))))))}let Pt="button";function mt(E,L){let F=oe(),{id:B=`headlessui-popover-button-${F}`,disabled:T=!1,autoFocus:n=!1,...g}=E,t=ye("Popover.Button"),[_,d,r,O,b,f,A]=Q(t,te(e=>[e.popoverState,t.selectors.isPortalled(e),e.button,e.buttonId,e.panel,e.panelId,e.afterButtonSentinel],[])),a=ie(null),i=`headlessui-focus-sentinel-${oe()}`,u=ke(),l=u==null?void 0:u.closeOthers,m=ct()!==null;pe(()=>{if(!m)return t.actions.setButtonId(B),()=>t.actions.setButtonId(null)},[m,B,t]);let[V]=ue(()=>Symbol()),j=z(a,L,et(),y(e=>{if(!m){if(e)t.state.buttons.current.push(V);else{let p=t.state.buttons.current.indexOf(V);p!==-1&&t.state.buttons.current.splice(p,1)}t.state.buttons.current.length>1&&console.warn("You are already using a <Popover.Button /> but only 1 <Popover.Button /> is supported."),e&&t.actions.setButton(e)}})),$=z(a,L),x=ce(a),J=y(e=>{var p,D,M;if(m){if(t.state.popoverState===c.Closed)return;switch(e.key){case W.Space:case W.Enter:e.preventDefault(),(D=(p=e.target).click)==null||D.call(p),t.actions.close(),(M=t.state.button)==null||M.focus();break}}else switch(e.key){case W.Space:case W.Enter:e.preventDefault(),e.stopPropagation(),t.state.popoverState===c.Closed?(l==null||l(t.state.buttonId),t.actions.open()):t.actions.close();break;case W.Escape:if(t.state.popoverState!==c.Open)return l==null?void 0:l(t.state.buttonId);if(!a.current||x!=null&&x.activeElement&&!a.current.contains(x.activeElement))return;e.preventDefault(),e.stopPropagation(),t.actions.close();break}}),ee=y(e=>{m||e.key===W.Space&&e.preventDefault()}),X=y(e=>{var p,D;Se(e.currentTarget)||T||(m?(t.actions.close(),(p=t.state.button)==null||p.focus()):(e.preventDefault(),e.stopPropagation(),t.state.popoverState===c.Closed?(l==null||l(t.state.buttonId),t.actions.open()):t.actions.close(),(D=t.state.button)==null||D.focus()))}),C=y(e=>{e.preventDefault(),e.stopPropagation()}),{isFocusVisible:H,focusProps:o}=He({autoFocus:n}),{isHovered:h,hoverProps:q}=Ue({isDisabled:T}),{pressed:G,pressProps:U}=Ne({disabled:T}),S=_===c.Open,N=re({open:S,active:G||S,disabled:T,hover:h,focus:H,autofocus:n}),ae=$e(E,r),Pe=m?be({ref:$,type:ae,onKeyDown:J,onClick:X,disabled:T||void 0,autoFocus:n},o,q,U):be({ref:j,id:O,type:ae,"aria-expanded":_===c.Open,"aria-controls":b?f:void 0,disabled:T||void 0,autoFocus:n,onKeyDown:J,onKeyUp:ee,onClick:X,onMouseDown:C},o,q,U),se=Oe(),s=y(()=>{if(!Me.isHTMLElement(t.state.panel))return;let e=t.state.panel;function p(){ne(se.current,{[k.Forwards]:()=>K(e,I.First),[k.Backwards]:()=>K(e,I.Last)})===Ee.Error&&K(Ge().filter(M=>M.dataset.headlessuiFocusGuard!=="true"),ne(se.current,{[k.Forwards]:I.Next,[k.Backwards]:I.Previous}),{relativeTo:t.state.button})}p()}),R=le();return v.createElement(v.Fragment,null,R({ourProps:Pe,theirProps:g,slot:N,defaultTag:Pt,name:"Popover.Button"}),S&&!m&&d&&v.createElement(ve,{id:i,ref:A,features:Te.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:s}))}let vt="div",Tt=de.RenderStrategy|de.Static;function Ie(E,L){let F=oe(),{id:B=`headlessui-popover-backdrop-${F}`,transition:T=!1,...n}=E,g=ye("Popover.Backdrop"),t=Q(g,te(l=>l.popoverState,[])),[_,d]=ue(null),r=z(L,d),O=he(),[b,f]=De(T,_,O!==null?(O&Y.Open)===Y.Open:t===c.Open),A=y(l=>{if(Se(l.currentTarget))return l.preventDefault();g.actions.close()}),a=re({open:t===c.Open}),i={ref:r,id:B,"aria-hidden":!0,onClick:A,...xe(f)};return le()({ourProps:i,theirProps:n,slot:a,defaultTag:vt,features:Tt,visible:b,name:"Popover.Backdrop"})}let Et="div",bt=de.RenderStrategy|de.Static;function yt(E,L){let F=oe(),{id:B=`headlessui-popover-panel-${F}`,focus:T=!1,anchor:n,portal:g=!1,modal:t=!1,transition:_=!1,...d}=E,r=ye("Popover.Panel"),O=Q(r,r.selectors.isPortalled),[b,f,A,a,i]=Q(r,te(s=>[s.popoverState,s.button,s.__demoMode,s.beforePanelSentinel,s.afterPanelSentinel],[])),u=`headlessui-focus-sentinel-before-${F}`,l=`headlessui-focus-sentinel-after-${F}`,P=ie(null),m=tt(n),[V,j]=Qe(m),$=Ze();m&&(g=!0);let[x,J]=ue(null),ee=z(P,L,m?V:null,r.actions.setPanel,J),X=ce(f),C=ce(P);We(()=>(r.actions.setPanelId(B),()=>r.actions.setPanelId(null)),[B,r]);let H=he(),[o,h]=De(_,x,H!==null?(H&Y.Open)===Y.Open:b===c.Open);Ve(o,f,r.actions.close),qe(A?!1:t&&o,C);let G=y(s=>{var R;switch(s.key){case W.Escape:if(r.state.popoverState!==c.Open||!P.current||C!=null&&C.activeElement&&!P.current.contains(C.activeElement))return;s.preventDefault(),s.stopPropagation(),r.actions.close(),(R=r.state.button)==null||R.focus();break}});pe(()=>{var s;E.static||b===c.Closed&&((s=E.unmount)==null||s)&&r.actions.setPanel(null)},[b,E.unmount,E.static,r]),pe(()=>{if(A||!T||b!==c.Open||!P.current)return;let s=C==null?void 0:C.activeElement;P.current.contains(s)||K(P.current,I.First)},[A,T,P.current,b]);let U=re({open:b===c.Open,close:r.actions.refocusableClose}),S=be(m?$():{},{ref:ee,id:B,onKeyDown:G,onBlur:T&&b===c.Open?s=>{var e,p,D,M,w;let R=s.relatedTarget;R&&P.current&&((e=P.current)!=null&&e.contains(R)||(r.actions.close(),((D=(p=a.current)==null?void 0:p.contains)!=null&&D.call(p,R)||(w=(M=i.current)==null?void 0:M.contains)!=null&&w.call(M,R))&&R.focus({preventScroll:!0})))}:void 0,tabIndex:-1,style:{...d.style,...j,"--button-width":we(o,f,!0).width},...xe(h)}),N=Oe(),ae=y(()=>{let s=P.current;if(!s)return;function R(){ne(N.current,{[k.Forwards]:()=>{var p;K(s,I.First)===Ee.Error&&((p=r.state.afterPanelSentinel.current)==null||p.focus())},[k.Backwards]:()=>{var e;(e=r.state.button)==null||e.focus({preventScroll:!0})}})}R()}),Pe=y(()=>{let s=P.current;if(!s)return;function R(){ne(N.current,{[k.Forwards]:()=>{if(!r.state.button)return;let e=Ge(),p=e.indexOf(r.state.button),D=e.slice(0,p+1),w=[...e.slice(p+1),...D];for(let me of w.slice())if(me.dataset.headlessuiFocusGuard==="true"||x!=null&&x.contains(me)){let Re=w.indexOf(me);Re!==-1&&w.splice(Re,1)}K(w,I.First,{sorted:!1})},[k.Backwards]:()=>{var p;K(s,I.Previous)===Ee.Error&&((p=r.state.button)==null||p.focus())}})}R()}),se=le();return v.createElement(rt,null,v.createElement(fe.Provider,{value:B},v.createElement(Le,{value:r.actions.refocusableClose},v.createElement(st,{enabled:g?E.static||o:!1,ownerDocument:X},o&&O&&v.createElement(ve,{id:u,ref:a,features:Te.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:ae}),se({ourProps:S,theirProps:d,slot:U,defaultTag:Et,features:bt,visible:o,name:"Popover.Panel"}),o&&O&&v.createElement(ve,{id:l,ref:i,features:Te.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:Pe})))))}let gt="div";function Rt(E,L){let F=ie(null),B=z(F,L),[T,n]=ue([]),g=y(a=>{n(i=>{let u=i.indexOf(a);if(u!==-1){let l=i.slice();return l.splice(u,1),l}return i})}),t=y(a=>(n(i=>[...i,a]),()=>g(a))),_=y(()=>{var u;let a=at(F);if(!a)return!1;let i=a.activeElement;return(u=F.current)!=null&&u.contains(i)?!0:T.some(l=>{var P,m;return((P=a.getElementById(l.buttonId.current))==null?void 0:P.contains(i))||((m=a.getElementById(l.panelId.current))==null?void 0:m.contains(i))})}),d=y(a=>{for(let i of T)i.buttonId.current!==a&&i.close()}),r=_e(()=>({registerPopover:t,unregisterPopover:g,isFocusWithinPopoverGroup:_,closeOthers:d}),[t,g,_,d]),O=re({}),b=E,f={ref:B},A=le();return v.createElement(Ce,null,v.createElement(ge.Provider,{value:r},A({ourProps:f,theirProps:b,slot:O,defaultTag:gt,name:"Popover.Group"})))}let Ft=Z(ft),Bt=Z(mt),_t=Z(Ie),At=Z(Ie),Ct=Z(yt),Ot=Z(Rt),co=Object.assign(Ft,{Button:Bt,Backdrop:At,Overlay:_t,Panel:Ct,Group:Ot});export{co as Popover,At as PopoverBackdrop,Bt as PopoverButton,Ot as PopoverGroup,_t as PopoverOverlay,Ct as PopoverPanel};
