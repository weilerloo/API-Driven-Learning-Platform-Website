"use client";import{useFocusRing as Ee}from"@react-aria/focus";import{useHover as Oe}from"@react-aria/interactions";import{useVirtualizer as we}from"@tanstack/react-virtual";import M,{Fragment as he,createContext as Ae,useCallback as Q,useContext as Ie,useMemo as ie,useRef as fe,useState as ye}from"react";import{flushSync as ne}from"react-dom";import{useActivePress as Be}from'../../hooks/use-active-press.js';import{useByComparator as Ne}from'../../hooks/use-by-comparator.js';import{useControllable as ke}from'../../hooks/use-controllable.js';import{useDefaultValue as Ue}from'../../hooks/use-default-value.js';import{useDisposables as He}from'../../hooks/use-disposables.js';import{useElementSize as Re}from'../../hooks/use-element-size.js';import{useEvent as O}from'../../hooks/use-event.js';import{useId as se}from'../../hooks/use-id.js';import{useInertOthers as Ge}from'../../hooks/use-inert-others.js';import{useIsoMorphicEffect as oe}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as ze}from'../../hooks/use-latest-value.js';import{useOnDisappear as Ke}from'../../hooks/use-on-disappear.js';import{useOutsideClick as We}from'../../hooks/use-outside-click.js';import{useOwnerDocument as Ce}from'../../hooks/use-owner.js';import{Action as ue,useQuickRelease as Xe}from'../../hooks/use-quick-release.js';import{useRefocusableInput as De}from'../../hooks/use-refocusable-input.js';import{useResolveButtonType as $e}from'../../hooks/use-resolve-button-type.js';import{useScrollLock as Je}from'../../hooks/use-scroll-lock.js';import{useSlot as pe}from'../../hooks/use-slot.js';import{useSyncRefs as Te}from'../../hooks/use-sync-refs.js';import{useTrackedPointer as je}from'../../hooks/use-tracked-pointer.js';import{transitionDataAttributes as qe,useTransition as Qe}from'../../hooks/use-transition.js';import{useTreeWalker as Ye}from'../../hooks/use-tree-walker.js';import{useWatch as _e}from'../../hooks/use-watch.js';import{useDisabled as Ze}from'../../internal/disabled.js';import{FloatingProvider as eo,useFloatingPanel as oo,useFloatingPanelProps as to,useFloatingReference as no,useResolvedAnchor as ro}from'../../internal/floating.js';import{FormFields as ao}from'../../internal/form-fields.js';import{Frozen as lo,useFrozenData as Fe}from'../../internal/frozen.js';import{useProvidedId as io}from'../../internal/id.js';import{OpenClosedProvider as so,State as xe,useOpenClosed as uo}from'../../internal/open-closed.js';import{stackMachines as po}from'../../machines/stack-machine.js';import{useSlice as I}from'../../react-glue.js';import{history as Se}from'../../utils/active-element-history.js';import{isDisabledReactIssue7711 as bo}from'../../utils/bugs.js';import{Focus as V}from'../../utils/calculate-active-index.js';import{disposables as mo}from'../../utils/disposables.js';import*as co from'../../utils/dom.js';import{match as ge}from'../../utils/match.js';import{isMobile as fo}from'../../utils/platform.js';import{RenderFeatures as Me,forwardRefWithAs as de,mergeProps as ve,useRender as be}from'../../utils/render.js';import{useDescribedBy as To}from'../description/description.js';import{Keys as w}from'../keyboard.js';import{Label as xo,useLabelledBy as Pe,useLabels as go}from'../label/label.js';import{MouseButton as Le}from'../mouse.js';import{Portal as yo}from'../portal/portal.js';import{ActionTypes as Co,ActivationTrigger as j,ComboboxState as l,ValueMode as k}from'./combobox-machine.js';import{ComboboxContext as vo,useComboboxMachine as Po,useComboboxMachineContext as me}from'./combobox-machine-glue.js';let ce=Ae(null);ce.displayName="ComboboxDataContext";function re(x){let P=Ie(ce);if(P===null){let e=new Error(`<${x} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(e,re),e}return P}let Ve=Ae(null);function Eo(x){let P=me("VirtualProvider"),e=re("VirtualProvider"),{options:o}=e.virtual,h=I(P,a=>a.optionsElement),[R,y]=ie(()=>{let a=h;if(!a)return[0,0];let i=window.getComputedStyle(a);return[parseFloat(i.paddingBlockStart||i.paddingTop),parseFloat(i.paddingBlockEnd||i.paddingBottom)]},[h]),c=we({enabled:o.length!==0,scrollPaddingStart:R,scrollPaddingEnd:y,count:o.length,estimateSize(){return 40},getScrollElement(){return P.state.optionsElement},overscan:12}),[A,m]=ye(0);oe(()=>{m(a=>a+1)},[o]);let T=c.getVirtualItems(),n=I(P,a=>a.activationTrigger===j.Pointer),f=I(P,P.selectors.activeOptionIndex);return T.length===0?null:M.createElement(Ve.Provider,{value:c},M.createElement("div",{style:{position:"relative",width:"100%",height:`${c.getTotalSize()}px`},ref:a=>{a&&(n||f!==null&&o.length>f&&c.scrollToIndex(f))}},T.map(a=>{var i;return M.createElement(he,{key:a.key},M.cloneElement((i=x.children)==null?void 0:i.call(x,{...x.slot,option:o[a.index]}),{key:`${A}-${a.key}`,"data-index":a.index,"aria-setsize":o.length,"aria-posinset":a.index+1,style:{position:"absolute",top:0,left:0,transform:`translateY(${a.start}px)`,overflowAnchor:"none"}}))})))}let Oo=he;function ho(x,P){let e=se(),o=Ze(),{value:h,defaultValue:R,onChange:y,form:c,name:A,by:m,invalid:T=!1,disabled:n=o||!1,onClose:f,__demoMode:a=!1,multiple:i=!1,immediate:_=!1,virtual:p=null,nullable:U,...W}=x,C=Ue(R),[g=i?[]:void 0,v]=ke(h,y,C),b=Po({id:e,virtual:p,__demoMode:a}),H=fe({static:!1,hold:!1}),F=Ne(m),G=O(u=>p?m===null?p.options.indexOf(u):p.options.findIndex(d=>F(d,u)):b.state.options.findIndex(d=>F(d.dataRef.current.value,u))),z=Q(u=>ge(r.mode,{[k.Multi]:()=>g.some(d=>F(d,u)),[k.Single]:()=>F(g,u)}),[g]),S=I(b,u=>u.virtual),q=O(()=>f==null?void 0:f()),r=ie(()=>({__demoMode:a,immediate:_,optionsPropsRef:H,value:g,defaultValue:C,disabled:n,invalid:T,mode:i?k.Multi:k.Single,virtual:p?S:null,onChange:v,isSelected:z,calculateIndex:G,compare:F,onClose:q}),[a,_,H,g,C,n,T,i,p,S,v,z,G,F,q]);oe(()=>{var u;p&&b.send({type:Co.UpdateVirtualConfiguration,options:p.options,disabled:(u=p.disabled)!=null?u:null})},[p,p==null?void 0:p.options,p==null?void 0:p.disabled]),oe(()=>{b.state.dataRef.current=r},[r]);let[B,Y,s,K]=I(b,u=>[u.comboboxState,u.buttonElement,u.inputElement,u.optionsElement]),X=po.get(null),Z=I(X,Q(u=>X.selectors.isTop(u,e),[X,e]));We(Z,[Y,s,K],()=>b.actions.closeCombobox());let ae=I(b,b.selectors.activeOptionIndex),le=I(b,b.selectors.activeOption),te=pe({open:B===l.Open,disabled:n,invalid:T,activeIndex:ae,activeOption:le,value:g}),[$,ee]=go(),t=P===null?{}:{ref:P},N=Q(()=>{if(C!==void 0)return v==null?void 0:v(C)},[v,C]),E=be();return M.createElement(ee,{value:$,props:{htmlFor:s==null?void 0:s.id},slot:{open:B===l.Open,disabled:n}},M.createElement(eo,null,M.createElement(ce.Provider,{value:r},M.createElement(vo.Provider,{value:b},M.createElement(so,{value:ge(B,{[l.Open]:xe.Open,[l.Closed]:xe.Closed})},A!=null&&M.createElement(ao,{disabled:n,data:g!=null?{[A]:g}:{},form:c,onReset:N}),E({ourProps:t,theirProps:W,slot:te,defaultTag:Oo,name:"Combobox"}))))))}let Ao="input";function Io(x,P){var $,ee;let e=me("Combobox.Input"),o=re("Combobox.Input"),h=se(),R=io(),{id:y=R||`headlessui-combobox-input-${h}`,onChange:c,displayValue:A,disabled:m=o.disabled||!1,autoFocus:T=!1,type:n="text",...f}=x,[a]=I(e,t=>[t.inputElement]),i=fe(null),_=Te(i,P,no(),e.actions.setInputElement),p=Ce(a),[U,W]=I(e,t=>[t.comboboxState,t.isTyping]),C=He(),g=O(()=>{e.actions.onChange(null),e.state.optionsElement&&(e.state.optionsElement.scrollTop=0),e.actions.goToOption({focus:V.Nothing})}),v=ie(()=>{var t;return typeof A=="function"&&o.value!==void 0?(t=A(o.value))!=null?t:"":typeof o.value=="string"?o.value:""},[o.value,A]);_e(([t,N],[E,u])=>{if(e.state.isTyping)return;let d=i.current;d&&((u===l.Open&&N===l.Closed||t!==E)&&(d.value=t),requestAnimationFrame(()=>{if(e.state.isTyping||!d||(p==null?void 0:p.activeElement)!==d)return;let{selectionStart:L,selectionEnd:J}=d;Math.abs((J!=null?J:0)-(L!=null?L:0))===0&&L===0&&d.setSelectionRange(d.value.length,d.value.length)}))},[v,U,p,W]),_e(([t],[N])=>{if(t===l.Open&&N===l.Closed){if(e.state.isTyping)return;let E=i.current;if(!E)return;let u=E.value,{selectionStart:d,selectionEnd:L,selectionDirection:J}=E;E.value="",E.value=u,J!==null?E.setSelectionRange(d,L,J):E.setSelectionRange(d,L)}},[U]);let b=fe(!1),H=O(()=>{b.current=!0}),F=O(()=>{C.nextFrame(()=>{b.current=!1})}),G=O(t=>{switch(e.actions.setIsTyping(!0),t.key){case w.Enter:if(e.state.comboboxState!==l.Open||b.current)return;if(t.preventDefault(),t.stopPropagation(),e.selectors.activeOptionIndex(e.state)===null){e.actions.closeCombobox();return}e.actions.selectActiveOption(),o.mode===k.Single&&e.actions.closeCombobox();break;case w.ArrowDown:return t.preventDefault(),t.stopPropagation(),ge(e.state.comboboxState,{[l.Open]:()=>e.actions.goToOption({focus:V.Next}),[l.Closed]:()=>e.actions.openCombobox()});case w.ArrowUp:return t.preventDefault(),t.stopPropagation(),ge(e.state.comboboxState,{[l.Open]:()=>e.actions.goToOption({focus:V.Previous}),[l.Closed]:()=>{ne(()=>e.actions.openCombobox()),o.value||e.actions.goToOption({focus:V.Last})}});case w.Home:if(t.shiftKey)break;return t.preventDefault(),t.stopPropagation(),e.actions.goToOption({focus:V.First});case w.PageUp:return t.preventDefault(),t.stopPropagation(),e.actions.goToOption({focus:V.First});case w.End:if(t.shiftKey)break;return t.preventDefault(),t.stopPropagation(),e.actions.goToOption({focus:V.Last});case w.PageDown:return t.preventDefault(),t.stopPropagation(),e.actions.goToOption({focus:V.Last});case w.Escape:return e.state.comboboxState!==l.Open?void 0:(t.preventDefault(),e.state.optionsElement&&!o.optionsPropsRef.current.static&&t.stopPropagation(),o.mode===k.Single&&o.value===null&&g(),e.actions.closeCombobox());case w.Tab:if(e.actions.setIsTyping(!1),e.state.comboboxState!==l.Open)return;o.mode===k.Single&&e.state.activationTrigger!==j.Focus&&e.actions.selectActiveOption(),e.actions.closeCombobox();break}}),z=O(t=>{c==null||c(t),o.mode===k.Single&&t.target.value===""&&g(),e.actions.openCombobox()}),S=O(t=>{var E,u,d;let N=(E=t.relatedTarget)!=null?E:Se.find(L=>L!==t.currentTarget);if(!((u=e.state.optionsElement)!=null&&u.contains(N))&&!((d=e.state.buttonElement)!=null&&d.contains(N))&&e.state.comboboxState===l.Open)return t.preventDefault(),o.mode===k.Single&&o.value===null&&g(),e.actions.closeCombobox()}),q=O(t=>{var E,u,d;let N=(E=t.relatedTarget)!=null?E:Se.find(L=>L!==t.currentTarget);(u=e.state.buttonElement)!=null&&u.contains(N)||(d=e.state.optionsElement)!=null&&d.contains(N)||o.disabled||o.immediate&&e.state.comboboxState!==l.Open&&C.microTask(()=>{ne(()=>e.actions.openCombobox()),e.actions.setActivationTrigger(j.Focus)})}),r=Pe(),B=To(),{isFocused:Y,focusProps:s}=Ee({autoFocus:T}),{isHovered:K,hoverProps:X}=Oe({isDisabled:m}),Z=I(e,t=>t.optionsElement),ae=pe({open:U===l.Open,disabled:m,invalid:o.invalid,hover:K,focus:Y,autofocus:T}),le=ve({ref:_,id:y,role:"combobox",type:n,"aria-controls":Z==null?void 0:Z.id,"aria-expanded":U===l.Open,"aria-activedescendant":I(e,e.selectors.activeDescendantId),"aria-labelledby":r,"aria-describedby":B,"aria-autocomplete":"list",defaultValue:(ee=($=x.defaultValue)!=null?$:o.defaultValue!==void 0?A==null?void 0:A(o.defaultValue):null)!=null?ee:o.defaultValue,disabled:m||void 0,autoFocus:T,onCompositionStart:H,onCompositionEnd:F,onKeyDown:G,onChange:z,onFocus:q,onBlur:S},s,X);return be()({ourProps:le,theirProps:f,slot:ae,defaultTag:Ao,name:"Combobox.Input"})}let Ro="button";function Do(x,P){let e=me("Combobox.Button"),o=re("Combobox.Button"),[h,R]=ye(null),y=Te(P,R,e.actions.setButtonElement),c=se(),{id:A=`headlessui-combobox-button-${c}`,disabled:m=o.disabled||!1,autoFocus:T=!1,...n}=x,[f,a,i]=I(e,r=>[r.comboboxState,r.inputElement,r.optionsElement]),_=De(a),p=f===l.Open;Xe(p,{trigger:h,action:Q(r=>{if(h!=null&&h.contains(r.target))return ue.Ignore;if(a!=null&&a.contains(r.target))return ue.Ignore;let B=r.target.closest('[role="option"]:not([data-disabled])');return co.isHTMLElement(B)?ue.Select(B):i!=null&&i.contains(r.target)?ue.Ignore:ue.Close},[h,a,i]),close:e.actions.closeCombobox,select:e.actions.selectActiveOption});let U=O(r=>{switch(r.key){case w.Space:case w.Enter:r.preventDefault(),r.stopPropagation(),e.state.comboboxState===l.Closed&&ne(()=>e.actions.openCombobox()),_();return;case w.ArrowDown:r.preventDefault(),r.stopPropagation(),e.state.comboboxState===l.Closed&&(ne(()=>e.actions.openCombobox()),e.state.dataRef.current.value||e.actions.goToOption({focus:V.First})),_();return;case w.ArrowUp:r.preventDefault(),r.stopPropagation(),e.state.comboboxState===l.Closed&&(ne(()=>e.actions.openCombobox()),e.state.dataRef.current.value||e.actions.goToOption({focus:V.Last})),_();return;case w.Escape:if(e.state.comboboxState!==l.Open)return;r.preventDefault(),e.state.optionsElement&&!o.optionsPropsRef.current.static&&r.stopPropagation(),ne(()=>e.actions.closeCombobox()),_();return;default:return}}),W=O(r=>{r.preventDefault(),!bo(r.currentTarget)&&(r.button===Le.Left&&(e.state.comboboxState===l.Open?e.actions.closeCombobox():e.actions.openCombobox()),_())}),C=Pe([A]),{isFocusVisible:g,focusProps:v}=Ee({autoFocus:T}),{isHovered:b,hoverProps:H}=Oe({isDisabled:m}),{pressed:F,pressProps:G}=Be({disabled:m}),z=pe({open:f===l.Open,active:F||f===l.Open,disabled:m,invalid:o.invalid,value:o.value,hover:b,focus:g}),S=ve({ref:y,id:A,type:$e(x,h),tabIndex:-1,"aria-haspopup":"listbox","aria-controls":i==null?void 0:i.id,"aria-expanded":f===l.Open,"aria-labelledby":C,disabled:m||void 0,autoFocus:T,onPointerDown:W,onKeyDown:U},v,H,G);return be()({ourProps:S,theirProps:n,slot:z,defaultTag:Ro,name:"Combobox.Button"})}let _o="div",Fo=Me.RenderStrategy|Me.Static;function So(x,P){var d,L,J;let e=se(),{id:o=`headlessui-combobox-options-${e}`,hold:h=!1,anchor:R,portal:y=!1,modal:c=!0,transition:A=!1,...m}=x,T=me("Combobox.Options"),n=re("Combobox.Options"),f=ro(R);f&&(y=!0);let[a,i]=oo(f),[_,p]=ye(null),U=to(),W=Te(P,f?a:null,T.actions.setOptionsElement,p),[C,g,v,b,H]=I(T,D=>[D.comboboxState,D.inputElement,D.buttonElement,D.optionsElement,D.activationTrigger]),F=Ce(g||v),G=Ce(b),z=uo(),[S,q]=Qe(A,_,z!==null?(z&xe.Open)===xe.Open:C===l.Open);Ke(S,g,T.actions.closeCombobox);let r=n.__demoMode?!1:c&&C===l.Open;Je(r,G);let B=n.__demoMode?!1:c&&C===l.Open;Ge(B,{allowed:Q(()=>[g,v,b],[g,v,b])});let s=I(T,T.selectors.didInputMove)?!1:S;oe(()=>{var D;n.optionsPropsRef.current.static=(D=x.static)!=null?D:!1},[n.optionsPropsRef,x.static]),oe(()=>{n.optionsPropsRef.current.hold=h},[n.optionsPropsRef,h]),Ye(C===l.Open,{container:b,accept(D){return D.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:D.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(D){D.setAttribute("role","none")}});let K=Pe([v==null?void 0:v.id]),X=pe({open:C===l.Open,option:void 0}),Z=O(()=>{T.actions.setActivationTrigger(j.Pointer)}),ae=O(D=>{D.preventDefault(),T.actions.setActivationTrigger(j.Pointer)}),le=ve(f?U():{},{"aria-labelledby":K,role:"listbox","aria-multiselectable":n.mode===k.Multi?!0:void 0,id:o,ref:W,style:{...m.style,...i,"--input-width":Re(S,g,!0).width,"--button-width":Re(S,v,!0).width},onWheel:H===j.Pointer?void 0:Z,onMouseDown:ae,...qe(q)}),te=S&&C===l.Closed&&!x.static,$=Fe(te,(d=n.virtual)==null?void 0:d.options),ee=Fe(te,n.value),t=Q(D=>n.compare(ee,D),[n.compare,ee]),N=ie(()=>{if(!n.virtual)return n;if($===void 0)throw new Error("Missing `options` in virtual mode");return $!==n.virtual.options?{...n,virtual:{...n.virtual,options:$}}:n},[n,$,(L=n.virtual)==null?void 0:L.options]);n.virtual&&Object.assign(m,{children:M.createElement(ce.Provider,{value:N},M.createElement(Eo,{slot:X},m.children))});let E=be(),u=ie(()=>n.mode===k.Multi?n:{...n,isSelected:t},[n,t]);return M.createElement(yo,{enabled:y?x.static||S:!1,ownerDocument:F},M.createElement(ce.Provider,{value:u},E({ourProps:le,theirProps:{...m,children:M.createElement(lo,{freeze:te},typeof m.children=="function"?(J=m.children)==null?void 0:J.call(m,X):m.children)},slot:X,defaultTag:_o,features:Fo,visible:s,name:"Combobox.Options"})))}let Mo="div";function Lo(x,P){var r,B,Y;let e=re("Combobox.Option"),o=me("Combobox.Option"),h=se(),{id:R=`headlessui-combobox-option-${h}`,value:y,disabled:c=(Y=(B=(r=e.virtual)==null?void 0:r.disabled)==null?void 0:B.call(r,y))!=null?Y:!1,order:A=null,...m}=x,[T]=I(o,s=>[s.inputElement]),n=De(T),f=I(o,Q(s=>o.selectors.isActive(s,y,R),[y,R])),a=e.isSelected(y),i=fe(null),_=ze({disabled:c,value:y,domRef:i,order:A}),p=Ie(Ve),U=Te(P,i,p?p.measureElement:null),W=O(()=>{o.actions.setIsTyping(!1),o.actions.onChange(y)});oe(()=>o.actions.registerOption(R,_),[_,R]);let C=I(o,Q(s=>o.selectors.shouldScrollIntoView(s,y,R),[y,R]));oe(()=>{if(C)return mo().requestAnimationFrame(()=>{var s,K;(K=(s=i.current)==null?void 0:s.scrollIntoView)==null||K.call(s,{block:"nearest"})})},[C,i]);let g=O(s=>{s.preventDefault(),s.button===Le.Left&&(c||(W(),fo()||requestAnimationFrame(()=>n()),e.mode===k.Single&&o.actions.closeCombobox()))}),v=O(()=>{if(c)return o.actions.goToOption({focus:V.Nothing});let s=e.calculateIndex(y);o.actions.goToOption({focus:V.Specific,idx:s})}),b=je(),H=O(s=>b.update(s)),F=O(s=>{if(!b.wasMoved(s)||c||f&&o.state.activationTrigger===j.Pointer)return;let K=e.calculateIndex(y);o.actions.goToOption({focus:V.Specific,idx:K},j.Pointer)}),G=O(s=>{b.wasMoved(s)&&(c||f&&(e.optionsPropsRef.current.hold||o.state.activationTrigger===j.Pointer&&o.actions.goToOption({focus:V.Nothing})))}),z=pe({active:f,focus:f,selected:a,disabled:c}),S={id:R,ref:U,role:"option",tabIndex:c===!0?void 0:-1,"aria-disabled":c===!0?!0:void 0,"aria-selected":a,disabled:void 0,onMouseDown:g,onFocus:v,onPointerEnter:H,onMouseEnter:H,onPointerMove:F,onMouseMove:F,onPointerLeave:G,onMouseLeave:G};return be()({ourProps:S,theirProps:m,slot:z,defaultTag:Mo,name:"Combobox.Option"})}let Vo=de(ho),wo=de(Do),Bo=de(Io),No=xo,ko=de(So),Uo=de(Lo),kt=Object.assign(Vo,{Input:Bo,Button:wo,Label:No,Options:ko,Option:Uo});export{kt as Combobox,wo as ComboboxButton,Bo as ComboboxInput,No as ComboboxLabel,Uo as ComboboxOption,ko as ComboboxOptions};
