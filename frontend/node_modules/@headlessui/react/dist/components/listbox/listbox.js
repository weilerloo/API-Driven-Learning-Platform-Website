"use client";import{useFocusRing as Ee}from"@react-aria/focus";import{useHover as he}from"@react-aria/interactions";import M,{Fragment as fe,createContext as Te,useCallback as K,useContext as me,useEffect as Re,useMemo as Ae,useRef as oe,useState as De}from"react";import{flushSync as $}from"react-dom";import{useActivePress as Se}from'../../hooks/use-active-press.js';import{useByComparator as _e}from'../../hooks/use-by-comparator.js';import{useControllable as Fe}from'../../hooks/use-controllable.js';import{useDefaultValue as Ce}from'../../hooks/use-default-value.js';import{useDisposables as Me}from'../../hooks/use-disposables.js';import{useElementSize as we}from'../../hooks/use-element-size.js';import{useEvent as D}from'../../hooks/use-event.js';import{useId as ne}from'../../hooks/use-id.js';import{useInertOthers as Be}from'../../hooks/use-inert-others.js';import{useIsoMorphicEffect as ue}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as Ie}from'../../hooks/use-latest-value.js';import{useOnDisappear as ke}from'../../hooks/use-on-disappear.js';import{useOutsideClick as Ue}from'../../hooks/use-outside-click.js';import{useOwnerDocument as be}from'../../hooks/use-owner.js';import{Action as re,useQuickRelease as Ne}from'../../hooks/use-quick-release.js';import{useResolveButtonType as He}from'../../hooks/use-resolve-button-type.js';import{useScrollLock as Ge}from'../../hooks/use-scroll-lock.js';import{useSlot as z}from'../../hooks/use-slot.js';import{useSyncRefs as q}from'../../hooks/use-sync-refs.js';import{useTextValue as Ve}from'../../hooks/use-text-value.js';import{useTrackedPointer as Ke}from'../../hooks/use-tracked-pointer.js';import{transitionDataAttributes as ze,useTransition as We}from'../../hooks/use-transition.js';import{useDisabled as Xe}from'../../internal/disabled.js';import{FloatingProvider as je,useFloatingPanel as Je,useFloatingPanelProps as Qe,useFloatingReference as $e,useFloatingReferenceProps as qe,useResolvedAnchor as Ye}from'../../internal/floating.js';import{FormFields as Ze}from'../../internal/form-fields.js';import{useFrozenData as et}from'../../internal/frozen.js';import{useProvidedId as tt}from'../../internal/id.js';import{OpenClosedProvider as ot,State as le,useOpenClosed as nt}from'../../internal/open-closed.js';import{stackMachines as rt}from'../../machines/stack-machine.js';import{useSlice as S}from'../../react-glue.js';import{isDisabledReactIssue7711 as lt}from'../../utils/bugs.js';import{Focus as v}from'../../utils/calculate-active-index.js';import{disposables as at}from'../../utils/disposables.js';import*as it from'../../utils/dom.js';import{Focus as ye,FocusableMode as st,focusFrom as pt,isFocusableElement as ut}from'../../utils/focus-management.js';import{attemptSubmit as dt}from'../../utils/form.js';import{match as ae}from'../../utils/match.js';import{getOwnerDocument as ct}from'../../utils/owner.js';import{RenderFeatures as xe,forwardRefWithAs as Y,mergeProps as Oe,useRender as Z}from'../../utils/render.js';import{useDescribedBy as ft}from'../description/description.js';import{Keys as d}from'../keyboard.js';import{Label as Tt,useLabelledBy as mt,useLabels as bt}from'../label/label.js';import{MouseButton as yt}from'../mouse.js';import{Portal as xt}from'../portal/portal.js';import{ActionTypes as Ot,ActivationTrigger as de,ListboxStates as T,ValueMode as I}from'./listbox-machine.js';import{ListboxContext as Lt,useListboxMachine as Pt,useListboxMachineContext as ce}from'./listbox-machine-glue.js';let ie=Te(null);ie.displayName="ListboxDataContext";function ee(b){let E=me(ie);if(E===null){let y=new Error(`<${b} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(y,ee),y}return E}let gt=fe;function vt(b,E){let y=ne(),u=Xe(),{value:p,defaultValue:a,form:_,name:i,onChange:m,by:n,invalid:x=!1,disabled:O=u||!1,horizontal:l=!1,multiple:t=!1,__demoMode:s=!1,...F}=b;const h=l?"horizontal":"vertical";let k=q(E),C=Ce(a),[c=t?[]:void 0,L]=Fe(p,m,C),f=Pt({id:y,__demoMode:s}),U=oe({static:!1,hold:!1}),H=oe(new Map),B=_e(n),V=K(g=>ae(r.mode,{[I.Multi]:()=>c.some(J=>B(J,g)),[I.Single]:()=>B(c,g)}),[c]),r=z({value:c,disabled:O,invalid:x,mode:t?I.Multi:I.Single,orientation:h,onChange:L,compare:B,isSelected:V,optionsPropsRef:U,listRef:H});ue(()=>{f.state.dataRef.current=r},[r]);let P=S(f,g=>g.listboxState),N=rt.get(null),G=S(N,K(g=>N.selectors.isTop(g,y),[N,y])),[R,W]=S(f,g=>[g.buttonElement,g.optionsElement]);Ue(G,[R,W],(g,J)=>{f.send({type:Ot.CloseListbox}),ut(J,st.Loose)||(g.preventDefault(),R==null||R.focus())});let X=z({open:P===T.Open,disabled:O,invalid:x,value:c}),[j,te]=bt({inherit:!0}),o={ref:k},w=K(()=>{if(C!==void 0)return L==null?void 0:L(C)},[L,C]),se=Z();return M.createElement(te,{value:j,props:{htmlFor:R==null?void 0:R.id},slot:{open:P===T.Open,disabled:O}},M.createElement(je,null,M.createElement(Lt.Provider,{value:f},M.createElement(ie.Provider,{value:r},M.createElement(ot,{value:ae(P,{[T.Open]:le.Open,[T.Closed]:le.Closed})},i!=null&&c!=null&&M.createElement(Ze,{disabled:O,data:{[i]:c},form:_,onReset:w}),se({ourProps:o,theirProps:F,slot:X,defaultTag:gt,name:"Listbox"}))))))}let Et="button";function ht(b,E){let y=ne(),u=tt(),p=ee("Listbox.Button"),a=ce("Listbox.Button"),{id:_=u||`headlessui-listbox-button-${y}`,disabled:i=p.disabled||!1,autoFocus:m=!1,...n}=b,x=q(E,$e(),a.actions.setButtonElement),O=qe(),[l,t,s]=S(a,o=>[o.listboxState,o.buttonElement,o.optionsElement]),F=l===T.Open;Ne(F,{trigger:t,action:K(o=>{if(t!=null&&t.contains(o.target))return re.Ignore;let w=o.target.closest('[role="option"]:not([data-disabled])');return it.isHTMLElement(w)?re.Select(w):s!=null&&s.contains(o.target)?re.Ignore:re.Close},[t,s]),close:a.actions.closeListbox,select:a.actions.selectActiveOption});let h=D(o=>{switch(o.key){case d.Enter:dt(o.currentTarget);break;case d.Space:case d.ArrowDown:o.preventDefault(),a.actions.openListbox({focus:p.value?v.Nothing:v.First});break;case d.ArrowUp:o.preventDefault(),a.actions.openListbox({focus:p.value?v.Nothing:v.Last});break}}),k=D(o=>{switch(o.key){case d.Space:o.preventDefault();break}}),C=D(o=>{var w;if(o.button===yt.Left){if(lt(o.currentTarget))return o.preventDefault();a.state.listboxState===T.Open?($(()=>a.actions.closeListbox()),(w=a.state.buttonElement)==null||w.focus({preventScroll:!0})):(o.preventDefault(),a.actions.openListbox({focus:v.Nothing}))}}),c=oe(null),L=D(o=>{c.current=o.pointerType,o.pointerType==="mouse"&&C(o)}),f=D(o=>{c.current!=="mouse"&&C(o)}),U=D(o=>o.preventDefault()),H=mt([_]),B=ft(),{isFocusVisible:V,focusProps:r}=Ee({autoFocus:m}),{isHovered:P,hoverProps:N}=he({isDisabled:i}),{pressed:G,pressProps:R}=Se({disabled:i}),W=z({open:l===T.Open,active:G||l===T.Open,disabled:i,invalid:p.invalid,value:p.value,hover:P,focus:V,autofocus:m}),X=S(a,o=>o.listboxState===T.Open),j=Oe(O(),{ref:x,id:_,type:He(b,t),"aria-haspopup":"listbox","aria-controls":s==null?void 0:s.id,"aria-expanded":X,"aria-labelledby":H,"aria-describedby":B,disabled:i||void 0,autoFocus:m,onKeyDown:h,onKeyUp:k,onKeyPress:U,onPointerDown:L,onClick:f},r,N,R);return Z()({ourProps:j,theirProps:n,slot:W,defaultTag:Et,name:"Listbox.Button"})}let Le=Te(!1),Rt="div",At=xe.RenderStrategy|xe.Static;function Dt(b,E){let y=ne(),{id:u=`headlessui-listbox-options-${y}`,anchor:p,portal:a=!1,modal:_=!0,transition:i=!1,...m}=b,n=Ye(p),[x,O]=De(null);n&&(a=!0);let l=ee("Listbox.Options"),t=ce("Listbox.Options"),[s,F,h,k]=S(t,e=>[e.listboxState,e.buttonElement,e.optionsElement,e.__demoMode]),C=be(F),c=be(h),L=nt(),[f,U]=We(i,x,L!==null?(L&le.Open)===le.Open:s===T.Open);ke(f,F,t.actions.closeListbox);let H=k?!1:_&&s===T.Open;Ge(H,c);let B=k?!1:_&&s===T.Open;Be(B,{allowed:K(()=>[F,h],[F,h])});let r=S(t,t.selectors.didButtonMove)?!1:f,P=f&&s===T.Closed&&!b.static,N=et(P,l.value),G=K(e=>l.compare(N,e),[l.compare,N]),R=S(t,e=>{var Q;if(n==null||!((Q=n==null?void 0:n.to)!=null&&Q.includes("selection")))return null;let A=e.options.findIndex(pe=>G(pe.dataRef.current.value));return A===-1&&(A=0),A}),W=(()=>{if(n==null)return;if(R===null)return{...n,inner:void 0};let e=Array.from(l.listRef.current.values());return{...n,inner:{listRef:{current:e},index:R}}})(),[X,j]=Je(W),te=Qe(),o=q(E,n?X:null,t.actions.setOptionsElement,O),w=Me();Re(()=>{var A;let e=h;e&&s===T.Open&&e!==((A=ct(e))==null?void 0:A.activeElement)&&(e==null||e.focus({preventScroll:!0}))},[s,h]);let se=D(e=>{var A,Q;switch(w.dispose(),e.key){case d.Space:if(t.state.searchQuery!=="")return e.preventDefault(),e.stopPropagation(),t.actions.search(e.key);case d.Enter:if(e.preventDefault(),e.stopPropagation(),t.state.activeOptionIndex!==null){let{dataRef:pe}=t.state.options[t.state.activeOptionIndex];t.actions.onChange(pe.current.value)}l.mode===I.Single&&($(()=>t.actions.closeListbox()),(A=t.state.buttonElement)==null||A.focus({preventScroll:!0}));break;case ae(l.orientation,{vertical:d.ArrowDown,horizontal:d.ArrowRight}):return e.preventDefault(),e.stopPropagation(),t.actions.goToOption({focus:v.Next});case ae(l.orientation,{vertical:d.ArrowUp,horizontal:d.ArrowLeft}):return e.preventDefault(),e.stopPropagation(),t.actions.goToOption({focus:v.Previous});case d.Home:case d.PageUp:return e.preventDefault(),e.stopPropagation(),t.actions.goToOption({focus:v.First});case d.End:case d.PageDown:return e.preventDefault(),e.stopPropagation(),t.actions.goToOption({focus:v.Last});case d.Escape:e.preventDefault(),e.stopPropagation(),$(()=>t.actions.closeListbox()),(Q=t.state.buttonElement)==null||Q.focus({preventScroll:!0});return;case d.Tab:e.preventDefault(),e.stopPropagation(),$(()=>t.actions.closeListbox()),pt(t.state.buttonElement,e.shiftKey?ye.Previous:ye.Next);break;default:e.key.length===1&&(t.actions.search(e.key),w.setTimeout(()=>t.actions.clearSearch(),350));break}}),g=S(t,e=>{var A;return(A=e.buttonElement)==null?void 0:A.id}),J=z({open:s===T.Open}),Pe=Oe(n?te():{},{id:u,ref:o,"aria-activedescendant":S(t,t.selectors.activeDescendantId),"aria-multiselectable":l.mode===I.Multi?!0:void 0,"aria-labelledby":g,"aria-orientation":l.orientation,onKeyDown:se,role:"listbox",tabIndex:s===T.Open?0:void 0,style:{...m.style,...j,"--button-width":we(f,F,!0).width},...ze(U)}),ge=Z(),ve=Ae(()=>l.mode===I.Multi?l:{...l,isSelected:G},[l,G]);return M.createElement(xt,{enabled:a?b.static||f:!1,ownerDocument:C},M.createElement(ie.Provider,{value:ve},ge({ourProps:Pe,theirProps:m,slot:J,defaultTag:Rt,features:At,visible:r,name:"Listbox.Options"})))}let St="div";function _t(b,E){let y=ne(),{id:u=`headlessui-listbox-option-${y}`,disabled:p=!1,value:a,..._}=b,i=me(Le)===!0,m=ee("Listbox.Option"),n=ce("Listbox.Option"),x=S(n,r=>n.selectors.isActive(r,u)),O=m.isSelected(a),l=oe(null),t=Ve(l),s=Ie({disabled:p,value:a,domRef:l,get textValue(){return t()}}),F=q(E,l,r=>{r?m.listRef.current.set(u,r):m.listRef.current.delete(u)}),h=S(n,r=>n.selectors.shouldScrollIntoView(r,u));ue(()=>{if(h)return at().requestAnimationFrame(()=>{var r,P;(P=(r=l.current)==null?void 0:r.scrollIntoView)==null||P.call(r,{block:"nearest"})})},[h,l]),ue(()=>{if(!i)return n.actions.registerOption(u,s),()=>n.actions.unregisterOption(u)},[s,u,i]);let k=D(r=>{var P;if(p)return r.preventDefault();n.actions.onChange(a),m.mode===I.Single&&($(()=>n.actions.closeListbox()),(P=n.state.buttonElement)==null||P.focus({preventScroll:!0}))}),C=D(()=>{if(p)return n.actions.goToOption({focus:v.Nothing});n.actions.goToOption({focus:v.Specific,id:u})}),c=Ke(),L=D(r=>c.update(r)),f=D(r=>{c.wasMoved(r)&&(p||x&&n.state.activationTrigger===de.Pointer||n.actions.goToOption({focus:v.Specific,id:u},de.Pointer))}),U=D(r=>{c.wasMoved(r)&&(p||x&&n.state.activationTrigger===de.Pointer&&n.actions.goToOption({focus:v.Nothing}))}),H=z({active:x,focus:x,selected:O,disabled:p,selectedOption:O&&i}),B=i?{}:{id:u,ref:F,role:"option",tabIndex:p===!0?void 0:-1,"aria-disabled":p===!0?!0:void 0,"aria-selected":O,disabled:void 0,onClick:k,onFocus:C,onPointerEnter:L,onMouseEnter:L,onPointerMove:f,onMouseMove:f,onPointerLeave:U,onMouseLeave:U},V=Z();return!O&&i?null:V({ourProps:B,theirProps:_,slot:H,defaultTag:St,name:"Listbox.Option"})}let Ft=fe;function Ct(b,E){let{options:y,placeholder:u,...p}=b,_={ref:q(E)},i=ee("ListboxSelectedOption"),m=z({}),n=i.value===void 0||i.value===null||i.mode===I.Multi&&Array.isArray(i.value)&&i.value.length===0,x=Z();return M.createElement(Le.Provider,{value:!0},x({ourProps:_,theirProps:{...p,children:M.createElement(M.Fragment,null,u&&n?u:y)},slot:m,defaultTag:Ft,name:"ListboxSelectedOption"}))}let Mt=Y(vt),wt=Y(ht),Bt=Tt,It=Y(Dt),kt=Y(_t),Ut=Y(Ct),Bo=Object.assign(Mt,{Button:wt,Label:Bt,Options:It,Option:kt,SelectedOption:Ut});export{Bo as Listbox,wt as ListboxButton,Bt as ListboxLabel,kt as ListboxOption,It as ListboxOptions,Ut as ListboxSelectedOption};
