var h=Object.defineProperty;var y=(e,o,t)=>o in e?h(e,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[o]=t;var S=(e,o,t)=>(y(e,typeof o!="symbol"?o+"":o,t),t);import{Machine as I,batch as v}from'../../machine.js';import{ActionTypes as R,stackMachines as A}from'../../machines/stack-machine.js';import{Focus as p,calculateActiveIndex as O}from'../../utils/calculate-active-index.js';import{ElementPositionState as b,computeVisualPosition as E,detectMovement as L}from'../../utils/element-movement.js';import{sortByDomNode as M}from'../../utils/focus-management.js';import{match as g}from'../../utils/match.js';var F=(t=>(t[t.Open=0]="Open",t[t.Closed=1]="Closed",t))(F||{}),C=(t=>(t[t.Single=0]="Single",t[t.Multi=1]="Multi",t))(C||{}),P=(t=>(t[t.Pointer=0]="Pointer",t[t.Other=1]="Other",t))(P||{}),k=(s=>(s[s.OpenListbox=0]="OpenListbox",s[s.CloseListbox=1]="CloseListbox",s[s.GoToOption=2]="GoToOption",s[s.Search=3]="Search",s[s.ClearSearch=4]="ClearSearch",s[s.RegisterOptions=5]="RegisterOptions",s[s.UnregisterOptions=6]="UnregisterOptions",s[s.SetButtonElement=7]="SetButtonElement",s[s.SetOptionsElement=8]="SetOptionsElement",s[s.SortOptions=9]="SortOptions",s[s.MarkButtonAsMoved=10]="MarkButtonAsMoved",s))(k||{});function m(e,o=t=>t){let t=e.activeOptionIndex!==null?e.options[e.activeOptionIndex]:null,n=M(o(e.options.slice()),r=>r.dataRef.current.domRef.current),i=t?n.indexOf(t):null;return i===-1&&(i=null),{options:n,activeOptionIndex:i}}let D={[1](e){if(e.dataRef.current.disabled||e.listboxState===1)return e;let o=e.buttonElement?b.Tracked(E(e.buttonElement)):e.buttonPositionState;return{...e,activeOptionIndex:null,pendingFocus:{focus:p.Nothing},listboxState:1,__demoMode:!1,buttonPositionState:o}},[0](e,o){if(e.dataRef.current.disabled||e.listboxState===0)return e;let t=e.activeOptionIndex,{isSelected:n}=e.dataRef.current,i=e.options.findIndex(r=>n(r.dataRef.current.value));return i!==-1&&(t=i),{...e,pendingFocus:o.focus,listboxState:0,activeOptionIndex:t,__demoMode:!1,buttonPositionState:b.Idle}},[2](e,o){var r,l,u,a,f;if(e.dataRef.current.disabled||e.listboxState===1)return e;let t={...e,searchQuery:"",activationTrigger:(r=o.trigger)!=null?r:1,__demoMode:!1};if(o.focus===p.Nothing)return{...t,activeOptionIndex:null};if(o.focus===p.Specific)return{...t,activeOptionIndex:e.options.findIndex(d=>d.id===o.id)};if(o.focus===p.Previous){let d=e.activeOptionIndex;if(d!==null){let s=e.options[d].dataRef.current.domRef,x=O(o,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:c=>c.id,resolveDisabled:c=>c.dataRef.current.disabled});if(x!==null){let c=e.options[x].dataRef.current.domRef;if(((l=s.current)==null?void 0:l.previousElementSibling)===c.current||((u=c.current)==null?void 0:u.previousElementSibling)===null)return{...t,activeOptionIndex:x}}}}else if(o.focus===p.Next){let d=e.activeOptionIndex;if(d!==null){let s=e.options[d].dataRef.current.domRef,x=O(o,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:c=>c.id,resolveDisabled:c=>c.dataRef.current.disabled});if(x!==null){let c=e.options[x].dataRef.current.domRef;if(((a=s.current)==null?void 0:a.nextElementSibling)===c.current||((f=c.current)==null?void 0:f.nextElementSibling)===null)return{...t,activeOptionIndex:x}}}}let n=m(e),i=O(o,{resolveItems:()=>n.options,resolveActiveIndex:()=>n.activeOptionIndex,resolveId:d=>d.id,resolveDisabled:d=>d.dataRef.current.disabled});return{...t,...n,activeOptionIndex:i}},[3]:(e,o)=>{if(e.dataRef.current.disabled||e.listboxState===1)return e;let n=e.searchQuery!==""?0:1,i=e.searchQuery+o.value.toLowerCase(),l=(e.activeOptionIndex!==null?e.options.slice(e.activeOptionIndex+n).concat(e.options.slice(0,e.activeOptionIndex+n)):e.options).find(a=>{var f;return!a.dataRef.current.disabled&&((f=a.dataRef.current.textValue)==null?void 0:f.startsWith(i))}),u=l?e.options.indexOf(l):-1;return u===-1||u===e.activeOptionIndex?{...e,searchQuery:i}:{...e,searchQuery:i,activeOptionIndex:u,activationTrigger:1}},[4](e){return e.dataRef.current.disabled||e.listboxState===1||e.searchQuery===""?e:{...e,searchQuery:""}},[5]:(e,o)=>{let t=e.options.concat(o.options),n=e.activeOptionIndex;if(e.pendingFocus.focus!==p.Nothing&&(n=O(e.pendingFocus,{resolveItems:()=>t,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:i=>i.id,resolveDisabled:i=>i.dataRef.current.disabled})),e.activeOptionIndex===null){let{isSelected:i}=e.dataRef.current;if(i){let r=t.findIndex(l=>i==null?void 0:i(l.dataRef.current.value));r!==-1&&(n=r)}}return{...e,options:t,activeOptionIndex:n,pendingFocus:{focus:p.Nothing},pendingShouldSort:!0}},[6]:(e,o)=>{let t=e.options,n=[],i=new Set(o.options);for(let[r,l]of t.entries())if(i.has(l.id)&&(n.push(r),i.delete(l.id),i.size===0))break;if(n.length>0){t=t.slice();for(let r of n.reverse())t.splice(r,1)}return{...e,options:t,activationTrigger:1}},[7]:(e,o)=>e.buttonElement===o.element?e:{...e,buttonElement:o.element},[8]:(e,o)=>e.optionsElement===o.element?e:{...e,optionsElement:o.element},[9]:e=>e.pendingShouldSort?{...e,...m(e),pendingShouldSort:!1}:e,[10](e){return e.buttonPositionState.kind!=="Tracked"?e:{...e,buttonPositionState:b.Moved}}};class T extends I{constructor(t){super(t);S(this,"actions",{onChange:t=>{let{onChange:n,compare:i,mode:r,value:l}=this.state.dataRef.current;return g(r,{[0]:()=>n==null?void 0:n(t),[1]:()=>{let u=l.slice(),a=u.findIndex(f=>i(f,t));return a===-1?u.push(t):u.splice(a,1),n==null?void 0:n(u)}})},registerOption:v(()=>{let t=[],n=new Set;return[(i,r)=>{n.has(r)||(n.add(r),t.push({id:i,dataRef:r}))},()=>(n.clear(),this.send({type:5,options:t.splice(0)}))]}),unregisterOption:v(()=>{let t=[];return[n=>t.push(n),()=>{this.send({type:6,options:t.splice(0)})}]}),goToOption:v(()=>{let t=null;return[(n,i)=>{t={type:2,...n,trigger:i}},()=>t&&this.send(t)]}),closeListbox:()=>{this.send({type:1})},openListbox:t=>{this.send({type:0,focus:t})},selectActiveOption:()=>{if(this.state.activeOptionIndex!==null){let{dataRef:t,id:n}=this.state.options[this.state.activeOptionIndex];this.actions.onChange(t.current.value),this.send({type:2,focus:p.Specific,id:n})}},selectOption:t=>{let n=this.state.options.find(i=>i.id===t);n&&this.actions.onChange(n.dataRef.current.value)},search:t=>{this.send({type:3,value:t})},clearSearch:()=>{this.send({type:4})},setButtonElement:t=>{this.send({type:7,element:t})},setOptionsElement:t=>{this.send({type:8,element:t})}});S(this,"selectors",{activeDescendantId(t){var r;let n=t.activeOptionIndex,i=t.options;return n===null||(r=i[n])==null?void 0:r.id},isActive(t,n){var l;let i=t.activeOptionIndex,r=t.options;return i!==null?((l=r[i])==null?void 0:l.id)===n:!1},shouldScrollIntoView(t,n){return t.__demoMode||t.listboxState!==0||t.activationTrigger===0?!1:this.isActive(t,n)},didButtonMove(t){return t.buttonPositionState.kind==="Moved"}});this.on(5,()=>{requestAnimationFrame(()=>{this.send({type:9})})});{let n=this.state.id,i=A.get(null);this.disposables.add(i.on(R.Push,r=>{!i.selectors.isTop(r,n)&&this.state.listboxState===0&&this.actions.closeListbox()})),this.on(0,()=>i.actions.push(n)),this.on(1,()=>i.actions.pop(n))}this.disposables.group(n=>{this.on(1,i=>{i.buttonElement&&(n.dispose(),n.add(L(i.buttonElement,i.buttonPositionState,()=>{this.send({type:10})})))})})}static new({id:t,__demoMode:n=!1}){return new T({id:t,dataRef:{current:{}},listboxState:n?0:1,options:[],searchQuery:"",activeOptionIndex:null,activationTrigger:1,buttonElement:null,optionsElement:null,pendingShouldSort:!1,pendingFocus:{focus:p.Nothing},__demoMode:n,buttonPositionState:b.Idle})}reduce(t,n){return g(n.type,D,t,n)}}export{k as ActionTypes,P as ActivationTrigger,T as ListboxMachine,F as ListboxStates,C as ValueMode};
